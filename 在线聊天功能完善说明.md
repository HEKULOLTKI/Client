# 在线聊天功能完善说明

## 概述

本次更新完善了在线聊天功能，主要包括：
- 使用工程师头像
- 完善文件上传功能
- 创建独立的在线聊天配置文件
- 增强用户体验和界面美观性

## 新增文件

### 1. `online_chat_config.py` - 在线聊天配置文件
- **用途**: 专门为在线聊天功能创建的配置文件，独立于宠物聊天配置
- **主要配置**:
  - 服务器地址和超时设置
  - 文件上传配置（大小限制、支持格式等）
  - 工程师头像路径配置
  - 界面主题颜色和字体
  - 心跳和重连机制配置

### 2. `file_upload_widget.py` - 文件上传组件
- **功能**: 完整的文件上传解决方案
- **特性**:
  - 支持拖拽上传
  - 多文件选择和批量上传
  - 实时上传进度显示
  - 文件类型验证和大小检查
  - 分块上传支持大文件
  - 美观的现代化界面

### 3. `test_online_chat.py` - 功能测试工具
- **用途**: 测试所有在线聊天功能
- **测试内容**:
  - 聊天窗口启动和显示
  - 文件上传组件测试
  - 工程师头像加载验证
  - 配置信息检查

## 主要改进

### 1. 头像系统升级
- **路径**: 使用 `image/engineer/` 目录下的工程师头像
- **头像类型**:
  - 用户头像：`system_architect.jpg`（系统架构师）
  - 在线用户头像：`network_engineer.jpg`（网络工程师）
  - 系统头像：`Network_Planning_and_Management_Engineer.jpg`（网络规划管理工程师）
- **备用机制**: 如果工程师头像不存在，自动回退到 `assets/` 目录下的备用头像

### 2. 文件上传功能完善
- **支持格式**: 图片、文档、代码、压缩包、音视频等30+种格式
- **文件大小**: 最大支持50MB文件上传
- **上传方式**:
  - 点击选择文件
  - 拖拽文件到上传区域
  - 批量选择多个文件
- **上传进度**: 实时显示上传进度条和状态
- **文件图标**: 根据文件类型显示相应的emoji图标

### 3. 界面优化
- **现代化设计**: 使用圆角、阴影、渐变等现代UI元素
- **响应式交互**: 悬停效果、点击反馈、动画过渡
- **色彩系统**: 统一的绿色主题配色方案
- **字体优化**: 使用微软雅黑UI字体，提升中文显示效果

### 4. 配置管理
- **模块化配置**: 将配置项分类组织
- **智能路径处理**: 自动处理相对路径和绝对路径
- **工具函数**: 提供文件大小格式化、文件类型检查等实用函数

## 使用方法

### 启动测试
```bash
python test_online_chat.py
```

### 直接使用聊天组件
```python
from online_chat_widget import OnlineChatWidget

# 创建聊天窗口
chat = OnlineChatWidget()
chat.set_user_info("用户名", "JWT_TOKEN")
chat.show()
```

### 单独使用文件上传
```python
from file_upload_widget import FileUploadWidget

# 创建文件上传组件
uploader = FileUploadWidget()
uploader.show()
```

## 配置说明

### 服务器配置
```python
CHAT_API_BASE_URL = "http://localhost:8000"  # API服务器地址
CHAT_API_TIMEOUT = 10  # 请求超时时间
HEARTBEAT_INTERVAL = 30000  # 心跳间隔（毫秒）
```

### 文件上传配置
```python
UPLOAD_MAX_SIZE = 50 * 1024 * 1024  # 最大文件大小 50MB
UPLOAD_ALLOWED_EXTENSIONS = [...]  # 支持的文件扩展名
UPLOAD_CHUNK_SIZE = 1024 * 1024  # 分块大小 1MB
```

### 头像配置
```python
# 自动选择最佳头像路径
avatar_path = config.get_avatar_path('user')  # 用户头像
avatar_path = config.get_avatar_path('online_user')  # 在线用户头像
avatar_path = config.get_avatar_path('system')  # 系统头像
```

## 技术特性

### 1. 异步处理
- 文件上传使用独立线程，不阻塞UI
- 心跳机制保持连接活跃
- API请求超时保护

### 2. 错误处理
- 网络连接失败自动进入离线模式
- 文件上传失败可重试
- 完善的异常处理和用户提示

### 3. 性能优化
- 头像缓存机制
- 分块上传支持大文件
- 智能消息加载限制

### 4. 用户体验
- 拖拽式文件上传
- 实时进度反馈
- 现代化界面设计
- 响应式交互效果

## 目录结构

```
项目根目录/
├── online_chat_config.py        # 在线聊天配置文件
├── online_chat_widget.py        # 在线聊天主组件（已更新）
├── file_upload_widget.py        # 文件上传组件
├── test_online_chat.py          # 功能测试工具
├── image/
│   └── engineer/                # 工程师头像目录
│       ├── system_architect.jpg
│       ├── network_engineer.jpg
│       └── Network_Planning_and_Management_Engineer.jpg
└── assets/                      # 备用头像目录
    ├── user.png
    └── pet_head.png
```

## 兼容性

- **Python版本**: Python 3.6+
- **PyQt5版本**: 5.12+
- **操作系统**: Windows、macOS、Linux
- **浏览器**: 支持现代浏览器的WebSocket连接

## 注意事项

1. **依赖检查**: 确保安装了所需的Python包：
   ```bash
   pip install PyQt5 requests
   ```

2. **头像文件**: 确保 `image/engineer/` 目录下有对应的头像文件

3. **服务器配置**: 根据实际API服务器地址修改配置文件

4. **Token管理**: 确保 `token_manager.py` 可以正确获取JWT token

## 更新日志

### v2.0.0 (当前版本)
- ✅ 新增工程师头像支持
- ✅ 完善文件上传功能
- ✅ 创建独立配置文件
- ✅ 优化界面设计
- ✅ 增强错误处理
- ✅ 添加功能测试工具

### v1.0.0 (原版本)
- 基础在线聊天功能
- 简单文件上传提示
- 使用宠物头像

## 开发者指南

### 自定义头像
在 `online_chat_config.py` 中修改头像路径：
```python
DEFAULT_USER_AVATAR = "your/custom/avatar/path.jpg"
```

### 扩展文件类型
在配置文件中添加新的文件扩展名：
```python
UPLOAD_ALLOWED_EXTENSIONS.append('.your_extension')
```

### 主题定制
修改 `COLORS` 字典来自定义界面颜色：
```python
COLORS = {
    'primary': '#your_color',
    # ...
}
```

## 支持

如有问题或建议，请通过以下方式联系：
- 查看测试输出日志
- 检查配置文件设置
- 验证依赖包版本 