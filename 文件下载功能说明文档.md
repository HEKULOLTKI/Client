# æ–‡ä»¶ä¸‹è½½åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

åœ¨çº¿èŠå¤©ç³»ç»Ÿæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ å„ç§ç±»å‹çš„æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ç”Ÿæˆçš„URLç›´æ¥ä¸‹è½½è®¿é—®ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬æµç¨‹
1. **ä¸Šä¼ æ–‡ä»¶** â†’ ç³»ç»Ÿè¿”å›æ–‡ä»¶URL
2. **ä½¿ç”¨URL** â†’ ç›´æ¥è®¿é—®ä¸‹è½½æ–‡ä»¶
3. **æ— éœ€è®¤è¯** â†’ é™æ€æ–‡ä»¶å¯å…¬å¼€è®¿é—®

### ç¤ºä¾‹æµç¨‹
```bash
# 1. ä¸Šä¼ æ–‡ä»¶ï¼ˆéœ€è¦è®¤è¯ï¼‰
POST /api/chat/upload
å“åº”: {"file_url": "/uploads/chat/abc123.txt"}

# 2. ä¸‹è½½æ–‡ä»¶ï¼ˆæ— éœ€è®¤è¯ï¼‰
GET http://localhost:8000/uploads/chat/abc123.txt
```

## ğŸ“¤ æ–‡ä»¶ä¸Šä¼ 

### APIæ¥å£
- **æ¥å£åœ°å€ï¼š** `POST /api/chat/upload`
- **è®¤è¯è¦æ±‚ï¼š** éœ€è¦JWT Token
- **è¯·æ±‚æ ¼å¼ï¼š** multipart/form-data

### è¯·æ±‚å‚æ•°
```
Content-Type: multipart/form-data

file: [æ–‡ä»¶] (å¿…éœ€)
room_id: [èŠå¤©å®¤ID] (å¯é€‰ï¼Œé»˜è®¤ä¸º"global")
```

### å“åº”æ ¼å¼
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "sender_id": 1,
  "sender_name": "å¼ ä¸‰",
  "message_type": "image",
  "content": "å‘é€äº†æ–‡ä»¶: photo.jpg",
  "file_url": "/uploads/chat/abc123.jpg",
  "file_name": "photo.jpg",
  "file_size": 1024000,
  "timestamp": "2024-01-15T10:30:00",
  "reply_to": null
}
```

### æ”¯æŒçš„æ–‡ä»¶ç±»å‹
- **å›¾ç‰‡ï¼š** JPEG, PNG, GIF, WebP
- **æ–‡æ¡£ï¼š** PDF, TXT, DOC, DOCX, XLS, XLSX
- **å¤§å°é™åˆ¶ï¼š** æœ€å¤§10MB

## ğŸ“¥ æ–‡ä»¶ä¸‹è½½

### ç›´æ¥URLè®¿é—®
æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡è¿”å›çš„`file_url`ç›´æ¥è®¿é—®ï¼š

```
å®Œæ•´URLæ ¼å¼ï¼š
http://localhost:8000{file_url}

ç¤ºä¾‹ï¼š
http://localhost:8000/uploads/chat/abc123.jpg
```

### ä¸‹è½½ç‰¹æ€§
- âœ… **æ— éœ€è®¤è¯**ï¼šé™æ€æ–‡ä»¶å¯ç›´æ¥è®¿é—®
- âœ… **æ”¯æŒæµè§ˆå™¨é¢„è§ˆ**ï¼šå›¾ç‰‡ã€PDFç­‰å¯åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æŸ¥çœ‹
- âœ… **è‡ªåŠ¨Content-Type**ï¼šæ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨è®¾ç½®MIMEç±»å‹
- âœ… **ç¼“å­˜æ”¯æŒ**ï¼šæµè§ˆå™¨å¯ç¼“å­˜æ–‡ä»¶å†…å®¹

## ğŸ’» å‰ç«¯é›†æˆ

### 1. JavaScript/Fetch API

#### ä¸‹è½½æ–‡ä»¶
```javascript
async function downloadFile(fileUrl, fileName) {
  try {
    const response = await fetch(`http://localhost:8000${fileUrl}`);
    
    if (response.ok) {
      const blob = await response.blob();
      
      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = fileName || 'download';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(downloadUrl);
      
      console.log('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
    } else {
      console.error('æ–‡ä»¶ä¸‹è½½å¤±è´¥:', response.status);
    }
  } catch (error) {
    console.error('ä¸‹è½½å¼‚å¸¸:', error);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
downloadFile('/uploads/chat/abc123.jpg', 'my-photo.jpg');
```

#### é¢„è§ˆå›¾ç‰‡
```javascript
function previewImage(fileUrl) {
  const img = document.createElement('img');
  img.src = `http://localhost:8000${fileUrl}`;
  img.style.maxWidth = '100%';
  img.style.height = 'auto';
  
  // æ·»åŠ åˆ°é¡µé¢
  document.getElementById('preview-container').appendChild(img);
}
```

#### æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
```javascript
async function checkFileExists(fileUrl) {
  try {
    const response = await fetch(`http://localhost:8000${fileUrl}`, {
      method: 'HEAD'  // åªè·å–å“åº”å¤´ï¼Œä¸ä¸‹è½½å†…å®¹
    });
    
    return response.ok;
  } catch (error) {
    return false;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const exists = await checkFileExists('/uploads/chat/abc123.jpg');
console.log('æ–‡ä»¶å­˜åœ¨:', exists);
```

### 2. HTMLç›´æ¥å¼•ç”¨

#### å›¾ç‰‡æ˜¾ç¤º
```html
<img src="http://localhost:8000/uploads/chat/abc123.jpg" 
     alt="ä¸Šä¼ çš„å›¾ç‰‡" 
     style="max-width: 300px;">
```

#### æ–‡ä»¶ä¸‹è½½é“¾æ¥
```html
<a href="http://localhost:8000/uploads/chat/document.pdf" 
   download="æˆ‘çš„æ–‡æ¡£.pdf"
   target="_blank">
  ä¸‹è½½æ–‡æ¡£
</a>
```

#### è§†é¢‘/éŸ³é¢‘æ’­æ”¾
```html
<!-- å¦‚æœæ”¯æŒè§†é¢‘æ–‡ä»¶ -->
<video controls style="max-width: 100%;">
  <source src="http://localhost:8000/uploads/chat/video.mp4" type="video/mp4">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
</video>
```

### 3. Vue.js ç»„ä»¶ç¤ºä¾‹

```vue
<template>
  <div class="file-download">
    <div v-if="isImage(fileUrl)" class="image-preview">
      <img :src="fullUrl" @load="onImageLoad" @error="onImageError" />
    </div>
    <div v-else class="file-link">
      <a :href="fullUrl" :download="fileName" target="_blank">
        ğŸ“ {{ fileName }}
      </a>
    </div>
    <button @click="downloadFile" class="download-btn">
      ä¸‹è½½æ–‡ä»¶
    </button>
  </div>
</template>

<script>
export default {
  props: {
    fileUrl: String,
    fileName: String
  },
  computed: {
    fullUrl() {
      return `http://localhost:8000${this.fileUrl}`;
    }
  },
  methods: {
    isImage(url) {
      return /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
    },
    
    async downloadFile() {
      try {
        const response = await fetch(this.fullUrl);
        const blob = await response.blob();
        
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = this.fileName;
        link.click();
        window.URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
      }
    },
    
    onImageLoad() {
      console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
    },
    
    onImageError() {
      console.error('å›¾ç‰‡åŠ è½½å¤±è´¥');
    }
  }
}
</script>
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. æ‰¹é‡ä¸‹è½½
```javascript
async function downloadMultipleFiles(fileUrls, fileNames) {
  for (let i = 0; i < fileUrls.length; i++) {
    await downloadFile(fileUrls[i], fileNames[i]);
    
    // æ·»åŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨é™åˆ¶
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
}
```

### 2. ä¸‹è½½è¿›åº¦ç›‘æ§
```javascript
async function downloadWithProgress(fileUrl, onProgress) {
  const response = await fetch(`http://localhost:8000${fileUrl}`);
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  const contentLength = response.headers.get('Content-Length');
  const total = parseInt(contentLength, 10);
  let loaded = 0;
  
  const reader = response.body.getReader();
  const chunks = [];
  
  while (true) {
    const { done, value } = await reader.read();
    
    if (done) break;
    
    chunks.push(value);
    loaded += value.length;
    
    if (onProgress && total) {
      onProgress({
        loaded,
        total,
        percentage: Math.round((loaded / total) * 100)
      });
    }
  }
  
  return new Blob(chunks);
}

// ä½¿ç”¨ç¤ºä¾‹
const blob = await downloadWithProgress('/uploads/chat/large-file.pdf', 
  (progress) => {
    console.log(`ä¸‹è½½è¿›åº¦: ${progress.percentage}%`);
  }
);
```

### 3. æ–‡ä»¶ä¿¡æ¯è·å–
```javascript
async function getFileInfo(fileUrl) {
  try {
    const response = await fetch(`http://localhost:8000${fileUrl}`, {
      method: 'HEAD'
    });
    
    if (response.ok) {
      return {
        size: response.headers.get('Content-Length'),
        type: response.headers.get('Content-Type'),
        lastModified: response.headers.get('Last-Modified'),
        exists: true
      };
    }
    
    return { exists: false };
  } catch (error) {
    return { exists: false, error: error.message };
  }
}
```

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1: æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¿”å›404é”™è¯¯
**åŸå› ï¼š**
- æ–‡ä»¶URLä¸æ­£ç¡®
- æ–‡ä»¶å·²è¢«åˆ é™¤
- æœåŠ¡å™¨è·¯å¾„é…ç½®é—®é¢˜

**è§£å†³ï¼š**
```javascript
// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
const exists = await checkFileExists(fileUrl);
if (!exists) {
  console.log('æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
}
```

### Q2: å›¾ç‰‡æ— æ³•æ˜¾ç¤º
**åŸå› ï¼š**
- å›¾ç‰‡æ–‡ä»¶æŸå
- ç½‘ç»œè¿æ¥é—®é¢˜
- æµè§ˆå™¨ç¼“å­˜é—®é¢˜

**è§£å†³ï¼š**
```javascript
// æ·»åŠ é”™è¯¯å¤„ç†
<img src="http://localhost:8000/uploads/chat/image.jpg" 
     onerror="this.src='path/to/placeholder.jpg'" />
```

### Q3: å¤§æ–‡ä»¶ä¸‹è½½ç¼“æ…¢
**åŸå› ï¼š**
- æ–‡ä»¶è¿‡å¤§
- ç½‘ç»œå¸¦å®½é™åˆ¶
- æœåŠ¡å™¨æ€§èƒ½

**è§£å†³ï¼š**
- ä½¿ç”¨ä¸‹è½½è¿›åº¦ç›‘æ§
- å®ç°æ–­ç‚¹ç»­ä¼ ï¼ˆå¦‚éœ€è¦ï¼‰
- å‹ç¼©å¤§æ–‡ä»¶åå†ä¸Šä¼ 

### Q4: è·¨åŸŸè®¿é—®é—®é¢˜
**åŸå› ï¼š**
- CORSé…ç½®é—®é¢˜
- ä¸åŒåŸŸåè®¿é—®

**è§£å†³ï¼š**
```javascript
// ç¡®ä¿CORSé…ç½®æ­£ç¡®
// æˆ–ä½¿ç”¨ä»£ç†è®¿é—®
const proxyUrl = `/api/proxy/download?url=${encodeURIComponent(fileUrl)}`;
```

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶è®¿é—®æ§åˆ¶
```javascript
// ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ è®¿é—®æƒé™æ£€æŸ¥
async function secureDownload(fileUrl, token) {
  const response = await fetch(`http://localhost:8000${fileUrl}`, {
    headers: {
      'Authorization': `Bearer ${token}`  // å¦‚æœéœ€è¦è®¤è¯
    }
  });
  
  if (response.status === 401) {
    throw new Error('æ— è®¿é—®æƒé™');
  }
  
  return response;
}
```

### 2. æ–‡ä»¶ç±»å‹éªŒè¯
```javascript
function validateFileType(fileUrl) {
  const allowedTypes = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.txt'];
  const fileExt = fileUrl.toLowerCase().split('.').pop();
  
  return allowedTypes.includes(`.${fileExt}`);
}
```

### 3. é˜²æ­¢æ¶æ„ä¸‹è½½
```javascript
// é™åˆ¶ä¸‹è½½é¢‘ç‡
class DownloadRateLimit {
  constructor(maxDownloads = 10, timeWindow = 60000) {
    this.maxDownloads = maxDownloads;
    this.timeWindow = timeWindow;
    this.downloads = [];
  }
  
  canDownload() {
    const now = Date.now();
    this.downloads = this.downloads.filter(time => now - time < this.timeWindow);
    
    if (this.downloads.length >= this.maxDownloads) {
      return false;
    }
    
    this.downloads.push(now);
    return true;
  }
}

const rateLimiter = new DownloadRateLimit();

async function safeDownload(fileUrl) {
  if (!rateLimiter.canDownload()) {
    throw new Error('ä¸‹è½½é¢‘ç‡è¿‡å¿«ï¼Œè¯·ç¨åå†è¯•');
  }
  
  return downloadFile(fileUrl);
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. é¢„åŠ è½½é‡è¦æ–‡ä»¶
```javascript
function preloadFiles(fileUrls) {
  fileUrls.forEach(url => {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = `http://localhost:8000${url}`;
    document.head.appendChild(link);
  });
}
```

### 2. å›¾ç‰‡æ‡’åŠ è½½
```javascript
const imageObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src;
      imageObserver.unobserve(img);
    }
  });
});

// ä½¿ç”¨
document.querySelectorAll('img[data-src]').forEach(img => {
  imageObserver.observe(img);
});
```

### 3. ç¼“å­˜ç­–ç•¥
```javascript
class FileCache {
  constructor() {
    this.cache = new Map();
  }
  
  async getFile(fileUrl) {
    if (this.cache.has(fileUrl)) {
      return this.cache.get(fileUrl);
    }
    
    const response = await fetch(`http://localhost:8000${fileUrl}`);
    const blob = await response.blob();
    
    this.cache.set(fileUrl, blob);
    return blob;
  }
}
```

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

### 1. å“åº”å¼å›¾ç‰‡
```css
.file-image {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}

@media (max-width: 768px) {
  .file-image {
    max-width: 90%;
  }
}
```

### 2. è§¦æ‘¸å‹å¥½çš„ä¸‹è½½æŒ‰é’®
```css
.download-btn {
  min-height: 44px;  /* iOSæ¨èæœ€å°è§¦æ‘¸ç›®æ ‡ */
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #007AFF;
  color: white;
  cursor: pointer;
}
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
```javascript
// æµ‹è¯•å¥—ä»¶ç¤ºä¾‹
describe('æ–‡ä»¶ä¸‹è½½åŠŸèƒ½', () => {
  test('åº”è¯¥èƒ½ä¸‹è½½å­˜åœ¨çš„æ–‡ä»¶', async () => {
    const exists = await checkFileExists('/uploads/chat/test.txt');
    expect(exists).toBe(true);
  });
  
  test('ä¸å­˜åœ¨çš„æ–‡ä»¶åº”è¯¥è¿”å›404', async () => {
    const exists = await checkFileExists('/uploads/chat/nonexistent.txt');
    expect(exists).toBe(false);
  });
  
  test('ä¸‹è½½çš„æ–‡ä»¶å†…å®¹åº”è¯¥å®Œæ•´', async () => {
    const response = await fetch('http://localhost:8000/uploads/chat/test.txt');
    const content = await response.text();
    expect(content.length).toBeGreaterThan(0);
  });
});
```

### 2. æ€§èƒ½æµ‹è¯•
```javascript
async function performanceTest(fileUrl) {
  const startTime = performance.now();
  
  await fetch(`http://localhost:8000${fileUrl}`);
  
  const endTime = performance.now();
  const duration = endTime - startTime;
  
  console.log(`æ–‡ä»¶ä¸‹è½½è€—æ—¶: ${duration}ms`);
  return duration;
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [APIæ¥å£è¯´æ˜æ–‡æ¡£](./APIæ¥å£è¯´æ˜æ–‡æ¡£.md)
- [èŠå¤©ç³»ç»Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—](./èŠå¤©ç³»ç»Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—.md)
- [CHAT_API_README](./CHAT_API_README.md)
- [æ–‡ä»¶ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š](./èŠå¤©ç³»ç»Ÿæ–‡ä»¶ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š.md)

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨ä½¿ç”¨æ–‡ä»¶ä¸‹è½½åŠŸèƒ½æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥æ–‡ä»¶URLæ˜¯å¦æ­£ç¡®
2. ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
4. å‚è€ƒæœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
5. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**æ›´æ–°æ—¶é—´ï¼š** 2024å¹´6æœˆ17æ—¥  
**ç‰ˆæœ¬ï¼š** v1.0  
**ä½œè€…ï¼š** å¼€å‘å›¢é˜Ÿ 