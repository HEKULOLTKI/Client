# 文件下载功能说明文档

## 📖 概述

在线聊天系统支持文件上传和下载功能，用户可以上传各种类型的文件，并通过生成的URL直接下载访问。本文档详细说明了如何使用文件下载功能。

## 🚀 快速开始

### 基本流程
1. **上传文件** → 系统返回文件URL
2. **使用URL** → 直接访问下载文件
3. **无需认证** → 静态文件可公开访问

### 示例流程
```bash
# 1. 上传文件（需要认证）
POST /api/chat/upload
响应: {"file_url": "/uploads/chat/abc123.txt"}

# 2. 下载文件（无需认证）
GET http://localhost:8000/uploads/chat/abc123.txt
```

## 📤 文件上传

### API接口
- **接口地址：** `POST /api/chat/upload`
- **认证要求：** 需要JWT Token
- **请求格式：** multipart/form-data

### 请求参数
```
Content-Type: multipart/form-data

file: [文件] (必需)
room_id: [聊天室ID] (可选，默认为"global")
```

### 响应格式
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "sender_id": 1,
  "sender_name": "张三",
  "message_type": "image",
  "content": "发送了文件: photo.jpg",
  "file_url": "/uploads/chat/abc123.jpg",
  "file_name": "photo.jpg",
  "file_size": 1024000,
  "timestamp": "2024-01-15T10:30:00",
  "reply_to": null
}
```

### 支持的文件类型
- **图片：** JPEG, PNG, GIF, WebP
- **文档：** PDF, TXT, DOC, DOCX, XLS, XLSX
- **大小限制：** 最大10MB

## 📥 文件下载

### 直接URL访问
文件上传成功后，可以通过返回的`file_url`直接访问：

```
完整URL格式：
http://localhost:8000{file_url}

示例：
http://localhost:8000/uploads/chat/abc123.jpg
```

### 下载特性
- ✅ **无需认证**：静态文件可直接访问
- ✅ **支持浏览器预览**：图片、PDF等可在浏览器中直接查看
- ✅ **自动Content-Type**：根据文件扩展名自动设置MIME类型
- ✅ **缓存支持**：浏览器可缓存文件内容

## 💻 前端集成

### 1. JavaScript/Fetch API

#### 下载文件
```javascript
async function downloadFile(fileUrl, fileName) {
  try {
    const response = await fetch(`http://localhost:8000${fileUrl}`);
    
    if (response.ok) {
      const blob = await response.blob();
      
      // 创建下载链接
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = fileName || 'download';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(downloadUrl);
      
      console.log('文件下载成功');
    } else {
      console.error('文件下载失败:', response.status);
    }
  } catch (error) {
    console.error('下载异常:', error);
  }
}

// 使用示例
downloadFile('/uploads/chat/abc123.jpg', 'my-photo.jpg');
```

#### 预览图片
```javascript
function previewImage(fileUrl) {
  const img = document.createElement('img');
  img.src = `http://localhost:8000${fileUrl}`;
  img.style.maxWidth = '100%';
  img.style.height = 'auto';
  
  // 添加到页面
  document.getElementById('preview-container').appendChild(img);
}
```

#### 检查文件是否存在
```javascript
async function checkFileExists(fileUrl) {
  try {
    const response = await fetch(`http://localhost:8000${fileUrl}`, {
      method: 'HEAD'  // 只获取响应头，不下载内容
    });
    
    return response.ok;
  } catch (error) {
    return false;
  }
}

// 使用示例
const exists = await checkFileExists('/uploads/chat/abc123.jpg');
console.log('文件存在:', exists);
```

### 2. HTML直接引用

#### 图片显示
```html
<img src="http://localhost:8000/uploads/chat/abc123.jpg" 
     alt="上传的图片" 
     style="max-width: 300px;">
```

#### 文件下载链接
```html
<a href="http://localhost:8000/uploads/chat/document.pdf" 
   download="我的文档.pdf"
   target="_blank">
  下载文档
</a>
```

#### 视频/音频播放
```html
<!-- 如果支持视频文件 -->
<video controls style="max-width: 100%;">
  <source src="http://localhost:8000/uploads/chat/video.mp4" type="video/mp4">
  您的浏览器不支持视频播放
</video>
```

### 3. Vue.js 组件示例

```vue
<template>
  <div class="file-download">
    <div v-if="isImage(fileUrl)" class="image-preview">
      <img :src="fullUrl" @load="onImageLoad" @error="onImageError" />
    </div>
    <div v-else class="file-link">
      <a :href="fullUrl" :download="fileName" target="_blank">
        📎 {{ fileName }}
      </a>
    </div>
    <button @click="downloadFile" class="download-btn">
      下载文件
    </button>
  </div>
</template>

<script>
export default {
  props: {
    fileUrl: String,
    fileName: String
  },
  computed: {
    fullUrl() {
      return `http://localhost:8000${this.fileUrl}`;
    }
  },
  methods: {
    isImage(url) {
      return /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
    },
    
    async downloadFile() {
      try {
        const response = await fetch(this.fullUrl);
        const blob = await response.blob();
        
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = this.fileName;
        link.click();
        window.URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error('下载失败:', error);
      }
    },
    
    onImageLoad() {
      console.log('图片加载成功');
    },
    
    onImageError() {
      console.error('图片加载失败');
    }
  }
}
</script>
```

## 🔧 高级用法

### 1. 批量下载
```javascript
async function downloadMultipleFiles(fileUrls, fileNames) {
  for (let i = 0; i < fileUrls.length; i++) {
    await downloadFile(fileUrls[i], fileNames[i]);
    
    // 添加延迟避免浏览器限制
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
}
```

### 2. 下载进度监控
```javascript
async function downloadWithProgress(fileUrl, onProgress) {
  const response = await fetch(`http://localhost:8000${fileUrl}`);
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  const contentLength = response.headers.get('Content-Length');
  const total = parseInt(contentLength, 10);
  let loaded = 0;
  
  const reader = response.body.getReader();
  const chunks = [];
  
  while (true) {
    const { done, value } = await reader.read();
    
    if (done) break;
    
    chunks.push(value);
    loaded += value.length;
    
    if (onProgress && total) {
      onProgress({
        loaded,
        total,
        percentage: Math.round((loaded / total) * 100)
      });
    }
  }
  
  return new Blob(chunks);
}

// 使用示例
const blob = await downloadWithProgress('/uploads/chat/large-file.pdf', 
  (progress) => {
    console.log(`下载进度: ${progress.percentage}%`);
  }
);
```

### 3. 文件信息获取
```javascript
async function getFileInfo(fileUrl) {
  try {
    const response = await fetch(`http://localhost:8000${fileUrl}`, {
      method: 'HEAD'
    });
    
    if (response.ok) {
      return {
        size: response.headers.get('Content-Length'),
        type: response.headers.get('Content-Type'),
        lastModified: response.headers.get('Last-Modified'),
        exists: true
      };
    }
    
    return { exists: false };
  } catch (error) {
    return { exists: false, error: error.message };
  }
}
```

## 🛠️ 常见问题

### Q1: 文件下载失败，返回404错误
**原因：**
- 文件URL不正确
- 文件已被删除
- 服务器路径配置问题

**解决：**
```javascript
// 检查文件是否存在
const exists = await checkFileExists(fileUrl);
if (!exists) {
  console.log('文件不存在或已被删除');
}
```

### Q2: 图片无法显示
**原因：**
- 图片文件损坏
- 网络连接问题
- 浏览器缓存问题

**解决：**
```javascript
// 添加错误处理
<img src="http://localhost:8000/uploads/chat/image.jpg" 
     onerror="this.src='path/to/placeholder.jpg'" />
```

### Q3: 大文件下载缓慢
**原因：**
- 文件过大
- 网络带宽限制
- 服务器性能

**解决：**
- 使用下载进度监控
- 实现断点续传（如需要）
- 压缩大文件后再上传

### Q4: 跨域访问问题
**原因：**
- CORS配置问题
- 不同域名访问

**解决：**
```javascript
// 确保CORS配置正确
// 或使用代理访问
const proxyUrl = `/api/proxy/download?url=${encodeURIComponent(fileUrl)}`;
```

## 🔒 安全注意事项

### 1. 文件访问控制
```javascript
// 生产环境建议添加访问权限检查
async function secureDownload(fileUrl, token) {
  const response = await fetch(`http://localhost:8000${fileUrl}`, {
    headers: {
      'Authorization': `Bearer ${token}`  // 如果需要认证
    }
  });
  
  if (response.status === 401) {
    throw new Error('无访问权限');
  }
  
  return response;
}
```

### 2. 文件类型验证
```javascript
function validateFileType(fileUrl) {
  const allowedTypes = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.txt'];
  const fileExt = fileUrl.toLowerCase().split('.').pop();
  
  return allowedTypes.includes(`.${fileExt}`);
}
```

### 3. 防止恶意下载
```javascript
// 限制下载频率
class DownloadRateLimit {
  constructor(maxDownloads = 10, timeWindow = 60000) {
    this.maxDownloads = maxDownloads;
    this.timeWindow = timeWindow;
    this.downloads = [];
  }
  
  canDownload() {
    const now = Date.now();
    this.downloads = this.downloads.filter(time => now - time < this.timeWindow);
    
    if (this.downloads.length >= this.maxDownloads) {
      return false;
    }
    
    this.downloads.push(now);
    return true;
  }
}

const rateLimiter = new DownloadRateLimit();

async function safeDownload(fileUrl) {
  if (!rateLimiter.canDownload()) {
    throw new Error('下载频率过快，请稍后再试');
  }
  
  return downloadFile(fileUrl);
}
```

## 📊 性能优化

### 1. 预加载重要文件
```javascript
function preloadFiles(fileUrls) {
  fileUrls.forEach(url => {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = `http://localhost:8000${url}`;
    document.head.appendChild(link);
  });
}
```

### 2. 图片懒加载
```javascript
const imageObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src;
      imageObserver.unobserve(img);
    }
  });
});

// 使用
document.querySelectorAll('img[data-src]').forEach(img => {
  imageObserver.observe(img);
});
```

### 3. 缓存策略
```javascript
class FileCache {
  constructor() {
    this.cache = new Map();
  }
  
  async getFile(fileUrl) {
    if (this.cache.has(fileUrl)) {
      return this.cache.get(fileUrl);
    }
    
    const response = await fetch(`http://localhost:8000${fileUrl}`);
    const blob = await response.blob();
    
    this.cache.set(fileUrl, blob);
    return blob;
  }
}
```

## 📱 移动端适配

### 1. 响应式图片
```css
.file-image {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}

@media (max-width: 768px) {
  .file-image {
    max-width: 90%;
  }
}
```

### 2. 触摸友好的下载按钮
```css
.download-btn {
  min-height: 44px;  /* iOS推荐最小触摸目标 */
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #007AFF;
  color: white;
  cursor: pointer;
}
```

## 🧪 测试建议

### 1. 功能测试
```javascript
// 测试套件示例
describe('文件下载功能', () => {
  test('应该能下载存在的文件', async () => {
    const exists = await checkFileExists('/uploads/chat/test.txt');
    expect(exists).toBe(true);
  });
  
  test('不存在的文件应该返回404', async () => {
    const exists = await checkFileExists('/uploads/chat/nonexistent.txt');
    expect(exists).toBe(false);
  });
  
  test('下载的文件内容应该完整', async () => {
    const response = await fetch('http://localhost:8000/uploads/chat/test.txt');
    const content = await response.text();
    expect(content.length).toBeGreaterThan(0);
  });
});
```

### 2. 性能测试
```javascript
async function performanceTest(fileUrl) {
  const startTime = performance.now();
  
  await fetch(`http://localhost:8000${fileUrl}`);
  
  const endTime = performance.now();
  const duration = endTime - startTime;
  
  console.log(`文件下载耗时: ${duration}ms`);
  return duration;
}
```

## 🔗 相关文档

- [API接口说明文档](./API接口说明文档.md)
- [聊天系统快速开始指南](./聊天系统快速开始指南.md)
- [CHAT_API_README](./CHAT_API_README.md)
- [文件上传测试报告](./聊天系统文件上传测试报告.md)

## 📞 技术支持

如果在使用文件下载功能时遇到问题，请：

1. 检查文件URL是否正确
2. 确认文件是否存在
3. 查看浏览器控制台错误信息
4. 参考本文档的常见问题部分
5. 联系技术支持团队

---

**更新时间：** 2024年6月17日  
**版本：** v1.0  
**作者：** 开发团队 