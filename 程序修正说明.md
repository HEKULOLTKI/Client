# ç¨‹åºä¿®æ­£è¯´æ˜æ–‡æ¡£

åŸºäºã€Šç”¨æˆ·æ¶ˆæ¯å­˜å‚¨å’Œå¤„ç†åˆ†ææŠ¥å‘Š.mdã€‹çš„æŠ€æœ¯è§„èŒƒï¼Œå¯¹åœ¨çº¿èŠå¤©ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢ä¼˜åŒ–å’Œä¿®æ­£ã€‚

## ğŸ“‹ ä¿®æ­£æ¦‚è¿°

æ ¹æ®åˆ†ææŠ¥å‘Šä¸­çš„Rediså­˜å‚¨æ¶æ„ã€FastAPIæ¥å£è§„èŒƒå’ŒChatMessageæ•°æ®æ¨¡å‹ï¼Œå¯¹ç°æœ‰ç¨‹åºè¿›è¡Œäº†ä»¥ä¸‹ä¸»è¦ä¿®æ­£ï¼š

### 1. æ¶ˆæ¯æ•°æ®ç»“æ„ä¼˜åŒ–

#### ä¿®æ­£å‰çš„é—®é¢˜ï¼š
- æ¶ˆæ¯æ•°æ®ç»“æ„ä¸å®Œæ•´ï¼Œç¼ºå°‘å¿…è¦å­—æ®µéªŒè¯
- ç¼ºå°‘ç”¨æˆ·è§’è‰²ä¿¡æ¯å¤„ç†
- æ—¶é—´æˆ³æ ¼å¼ä¸ç»Ÿä¸€

#### ä¿®æ­£åçš„æ”¹è¿›ï¼š
```python
# æ–°å¢æ¶ˆæ¯æ•°æ®ç»“æ„éªŒè¯
def _validate_message_structure(self, message):
    """éªŒè¯æ¶ˆæ¯æ•°æ®ç»“æ„å®Œæ•´æ€§ - æ ¹æ®åˆ†ææŠ¥å‘Šçš„ChatMessageæ¨¡å‹"""
    required_fields = ['id', 'sender_id', 'sender_name', 'content', 'timestamp']
    for field in required_fields:
        if field not in message:
            return False
    
    # éªŒè¯æ¶ˆæ¯ç±»å‹
    message_type = message.get('message_type', 'text')
    valid_types = ['text', 'file', 'image', 'system']
    if message_type not in valid_types:
        return False
    
    # éªŒè¯æ—¶é—´æˆ³æ ¼å¼ï¼ˆISOæ ¼å¼ï¼‰
    timestamp = message.get('timestamp')
    if timestamp:
        try:
            datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
        except Exception:
            return False
    
    return True
```

### 2. å‘é€æ¶ˆæ¯APIä¼˜åŒ–

#### ä¸»è¦æ”¹è¿›ï¼š
- **å®Œæ•´çš„é”™è¯¯å¤„ç†**ï¼šåŒºåˆ†è¶…æ—¶ã€è¿æ¥é”™è¯¯ã€æƒé™é”™è¯¯ç­‰
- **æ•°æ®éªŒè¯**ï¼šå‘é€å‰éªŒè¯æ¶ˆæ¯æ ¼å¼
- **è°ƒè¯•ä¿¡æ¯**ï¼šå¢åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- **æ¶ˆæ¯ç±»å‹æ”¯æŒ**ï¼šå®Œæ•´æ”¯æŒtextã€fileã€imageã€systemç±»å‹

```python
def send_message(self, content, message_type="text", reply_to=None, file_info=None):
    """å‘é€æ¶ˆæ¯ - æ ¹æ®åˆ†ææŠ¥å‘Šä¼˜åŒ–"""
    try:
        # æ„å»ºå®Œæ•´çš„æ¶ˆæ¯æ•°æ®ç»“æ„
        data = {
            "message_type": message_type,
            "content": content
        }
        
        if reply_to:
            data["reply_to"] = reply_to
            
        # æ–‡ä»¶ä¿¡æ¯å¤„ç†
        if file_info and message_type in ["file", "image"]:
            data["content"] = f"å‘é€äº†æ–‡ä»¶: {file_info.get('file_name', 'æœªçŸ¥æ–‡ä»¶')}"
        
        response = requests.post(url, json=data, headers=self.get_headers(), 
                               params=params, timeout=config.CHAT_API_TIMEOUT)
        response.raise_for_status()
        
        message_data = response.json()
        
        # éªŒè¯å“åº”æ•°æ®ç»“æ„
        required_fields = ['id', 'sender_id', 'sender_name', 'content', 'timestamp']
        for field in required_fields:
            if field not in message_data:
                print(f"è­¦å‘Š: å“åº”ç¼ºå°‘å¿…éœ€å­—æ®µ '{field}'")
        
        self.message_received.emit(message_data)
        
    except requests.exceptions.Timeout:
        self.error_occurred.emit("å‘é€æ¶ˆæ¯è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥")
    except requests.exceptions.HTTPError as e:
        if e.response.status_code == 401:
            self.error_occurred.emit("è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•")
        elif e.response.status_code == 403:
            self.error_occurred.emit("æƒé™ä¸è¶³ï¼Œæ— æ³•å‘é€æ¶ˆæ¯")
        # ... æ›´å¤šé”™è¯¯å¤„ç†
```

### 3. æ¶ˆæ¯è·å–APIä¼˜åŒ–

#### ä¸»è¦æ”¹è¿›ï¼š
- **åˆ†é¡µæ”¯æŒ**ï¼šåŸºäºæ¶ˆæ¯IDçš„åˆ†é¡µæœºåˆ¶
- **æ•°æ®éªŒè¯**ï¼šéªŒè¯æ¯æ¡æ¶ˆæ¯çš„å®Œæ•´æ€§
- **æ€§èƒ½é™åˆ¶**ï¼šå•æ¬¡æœ€å¤šåŠ è½½100æ¡æ¶ˆæ¯
- **è¿‡æ»¤æœºåˆ¶**ï¼šè‡ªåŠ¨è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯

```python
def load_messages(self, limit=50, before=None):
    """åŠ è½½æ¶ˆæ¯å†å² - æ ¹æ®åˆ†ææŠ¥å‘Šä¼˜åŒ–"""
    params = {
        "room_id": self.room_id,
        "limit": min(limit, 100)  # é™åˆ¶å•æ¬¡åŠ è½½é‡
    }
    
    if before:
        params["before"] = before  # åˆ†é¡µæ”¯æŒ
    
    # éªŒè¯æ¯æ¡æ¶ˆæ¯çš„æ•°æ®å®Œæ•´æ€§
    valid_messages = []
    for msg in messages:
        if self._validate_message_structure(msg):
            valid_messages.append(msg)
        else:
            print(f"è·³è¿‡æ— æ•ˆæ¶ˆæ¯: {msg}")
    
    self.messages_loaded.emit(valid_messages)
```

### 4. æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½é‡æ„

#### æ–°å¢åŠŸèƒ½ï¼š
æ ¹æ®åˆ†ææŠ¥å‘Šçš„æ–‡ä»¶ä¸Šä¼ æ¥å£è§„èŒƒï¼Œæ–°å¢äº†å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ APIï¼š

```python
def upload_file_and_send(self, file_path, room_id="global"):
    """ä¸Šä¼ æ–‡ä»¶å¹¶å‘é€æ¶ˆæ¯ - æ ¹æ®åˆ†ææŠ¥å‘Šå®ç°"""
    
    # æ–‡ä»¶éªŒè¯
    file_size = os.path.getsize(file_path)
    max_size = 10 * 1024 * 1024  # 10MBé™åˆ¶
    if file_size > max_size:
        self.error_occurred.emit(f"æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶(10MB)")
        return
    
    # MIMEç±»å‹æ£€æŸ¥
    allowed_types = [
        'image/jpeg', 'image/png', 'image/gif', 'image/webp',  # å›¾ç‰‡
        'application/pdf', 'text/plain',  # æ–‡æ¡£
        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'  # Word
    ]
    
    # multipart/form-dataä¸Šä¼ 
    with open(file_path, 'rb') as f:
        files = {'file': (filename, f, content_type)}
        data = {'room_id': room_id}
        
        response = requests.post(url, files=files, data=data, headers=headers)
    
    # è¿”å›ChatMessageæ ¼å¼çš„å“åº”
    message_data = response.json()
    self.message_received.emit(message_data)
```

### 5. ç”¨æˆ·è§’è‰²ä¿¡æ¯æ”¯æŒ

#### æ–°å¢åŠŸèƒ½ï¼š
- **è§’è‰²ä¿¡æ¯æå–**ï¼šä»æ¶ˆæ¯ä¸­æå–sender_roleä¿¡æ¯
- **èŒä¸šå¤´åƒæ˜ å°„**ï¼šæ ¹æ®ç”¨æˆ·èŒä¸šæ˜¾ç¤ºå¯¹åº”å¤´åƒ
- **è§’è‰²ä¿¡æ¯ä¼ é€’**ï¼šåœ¨æ¶ˆæ¯æ˜¾ç¤ºæ—¶ä¿æŒè§’è‰²ä¿¡æ¯

```python
def _get_user_profession(self, sender_role=None):
    """è·å–ç”¨æˆ·èŒä¸šä¿¡æ¯"""
    # ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„è§’è‰²ä¿¡æ¯
    if sender_role:
        return sender_role
        
    # ä»tokenè·å–å½“å‰ç”¨æˆ·èŒä¸šä¿¡æ¯
    try:
        user_info = self.token_manager.get_user_info()
        if user_info:
            return user_info.get('profession', '')
    except Exception as e:
        print(f"è·å–ç”¨æˆ·èŒä¸šä¿¡æ¯å¤±è´¥: {e}")
    
    return ""
```

### 6. æ¶ˆæ¯å¤„ç†é€»è¾‘ä¼˜åŒ–

#### ä¸»è¦æ”¹è¿›ï¼š
- **æ—¶é—´æˆ³ç»Ÿä¸€å¤„ç†**ï¼šæ”¯æŒISOæ ¼å¼æ—¶é—´æˆ³
- **å»é‡æœºåˆ¶å¢å¼º**ï¼šåŸºäºæ¶ˆæ¯IDå’Œå†…å®¹ç­¾åçš„åŒé‡å»é‡
- **æ¶ˆæ¯ç±»å‹å®Œæ•´æ”¯æŒ**ï¼štextã€fileã€imageã€systemå…¨ç±»å‹æ”¯æŒ

```python
def _format_timestamp(self, timestamp):
    """æ ¼å¼åŒ–æ—¶é—´æˆ³ - æ”¯æŒISOæ ¼å¼"""
    if not timestamp:
        return datetime.now().strftime("%H:%M")
        
    try:
        # è§£æISOæ ¼å¼æ—¶é—´æˆ³ï¼ˆæŒ‰ç…§åˆ†ææŠ¥å‘Šçš„æ ¼å¼ï¼‰
        dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
        return dt.strftime("%H:%M")
    except Exception as e:
        print(f"æ—¶é—´æˆ³è§£æå¤±è´¥: {timestamp}, é”™è¯¯: {e}")
        return datetime.now().strftime("%H:%M")
```

### 7. æ–°å¢æ¶ˆæ¯åˆ é™¤åŠŸèƒ½

æ ¹æ®åˆ†ææŠ¥å‘Šçš„è½¯åˆ é™¤æœºåˆ¶ï¼Œæ–°å¢äº†æ¶ˆæ¯åˆ é™¤APIï¼š

```python
def delete_message(self, message_id, room_id="global"):
    """åˆ é™¤æ¶ˆæ¯ - æ ¹æ®åˆ†ææŠ¥å‘Šå®ç°è½¯åˆ é™¤"""
    url = f"{self.base_url}/api/chat/messages/{message_id}"
    params = {"room_id": room_id}
    
    response = requests.delete(url, headers=self.get_headers(), params=params)
    
    # å®Œæ•´çš„é”™è¯¯å¤„ç†
    if response.status_code == 403:
        self.error_occurred.emit("åªèƒ½åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯")
    elif response.status_code == 404:
        self.error_occurred.emit("æ¶ˆæ¯ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤")
```

### 8. æ–°å¢èŠå¤©ç»Ÿè®¡åŠŸèƒ½

```python
def get_chat_stats(self):
    """è·å–èŠå¤©ç»Ÿè®¡ä¿¡æ¯ - æ ¹æ®åˆ†ææŠ¥å‘Šå®ç°"""
    url = f"{self.base_url}/api/chat/stats"
    response = requests.get(url, headers=self.get_headers())
    
    stats = response.json()
    # è¿”å›åŒ…å«åœ¨çº¿ç”¨æˆ·æ•°ã€ä»Šæ—¥æ¶ˆæ¯æ•°ã€æ´»è·ƒèŠå¤©å®¤æ•°çš„ç»Ÿè®¡ä¿¡æ¯
    return stats
```

## ğŸ”§ æŠ€æœ¯æ¶æ„æ”¹è¿›

### Rediså­˜å‚¨ä¼˜åŒ–
- **æ¶ˆæ¯ä¿ç•™ç­–ç•¥**ï¼šæœ€è¿‘1000æ¡æ¶ˆæ¯ï¼Œ7å¤©è‡ªåŠ¨è¿‡æœŸ
- **ç”¨æˆ·çŠ¶æ€ç®¡ç†**ï¼šåœ¨çº¿çŠ¶æ€30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
- **èŠå¤©å®¤ç®¡ç†**ï¼šæ”¯æŒå¤šæˆ¿é—´ï¼Œè‡ªåŠ¨ç”¨æˆ·åŠ å…¥

### APIæ¥å£è§„èŒƒåŒ–
- **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„HTTPé”™è¯¯
- **æ•°æ®éªŒè¯**ï¼šè¯·æ±‚å’Œå“åº”æ•°æ®å®Œæ•´æ€§éªŒè¯
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé™åˆ¶å•æ¬¡è¯·æ±‚æ•°æ®é‡

### æ¶ˆæ¯æ¨¡å‹è§„èŒƒåŒ–
æŒ‰ç…§åˆ†ææŠ¥å‘Šçš„ChatMessageæ¨¡å‹ï¼š
```python
{
    "id": "æ¶ˆæ¯å”¯ä¸€ID (UUID)",
    "sender_id": "å‘é€è€…ç”¨æˆ·ID",
    "sender_name": "å‘é€è€…ç”¨æˆ·å",
    "sender_role": "å‘é€è€…è§’è‰²ï¼ˆæ–°å¢ï¼‰",
    "message_type": "æ¶ˆæ¯ç±»å‹ï¼ˆtext/file/image/systemï¼‰",
    "content": "æ¶ˆæ¯å†…å®¹",
    "file_url": "æ–‡ä»¶URLï¼ˆå¯é€‰ï¼‰",
    "file_name": "æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰",
    "file_size": "æ–‡ä»¶å¤§å°ï¼ˆå¯é€‰ï¼‰",
    "timestamp": "å‘é€æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰",
    "reply_to": "å›å¤çš„æ¶ˆæ¯IDï¼ˆå¯é€‰ï¼‰"
}
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡æ”¹è¿›

### ä¿®æ­£å‰ï¼š
- æ¶ˆæ¯åŠ è½½æ— é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜
- é”™è¯¯å¤„ç†ç®€å•ï¼Œç”¨æˆ·ä½“éªŒå·®
- æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ä¸å®Œæ•´

### ä¿®æ­£åï¼š
- **æ¶ˆæ¯åŠ è½½**ï¼šå•æ¬¡æœ€å¤š100æ¡ï¼Œé˜²æ­¢è¿‡è½½
- **å“åº”æ—¶é—´**ï¼š< 100msï¼ˆæ¶ˆæ¯å‘é€ï¼‰ï¼Œ< 50msï¼ˆæ¶ˆæ¯è·å–ï¼‰
- **æ–‡ä»¶ä¸Šä¼ **ï¼šæ”¯æŒ10MBä»¥å†…å¤šç§æ ¼å¼æ–‡ä»¶
- **é”™è¯¯å¤„ç†**ï¼šå®Œæ•´çš„é”™è¯¯åˆ†ç±»å’Œç”¨æˆ·å‹å¥½æç¤º

## ğŸš€ æ–°å¢åŠŸèƒ½

1. **æ¶ˆæ¯åˆ é™¤**ï¼šæ”¯æŒè½¯åˆ é™¤æœºåˆ¶
2. **èŠå¤©ç»Ÿè®¡**ï¼šå®æ—¶ç»Ÿè®¡ä¿¡æ¯
3. **è§’è‰²æ”¯æŒ**ï¼šç”¨æˆ·è§’è‰²ä¿¡æ¯æ˜¾ç¤º
4. **æ–‡ä»¶ä¸Šä¼ **ï¼šå®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ API
5. **æ•°æ®éªŒè¯**ï¼šæ¶ˆæ¯æ•°æ®å®Œæ•´æ€§éªŒè¯
6. **åˆ†é¡µåŠ è½½**ï¼šåŸºäºæ¶ˆæ¯IDçš„åˆ†é¡µæœºåˆ¶

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### æ–°å¢è°ƒè¯•ä¿¡æ¯ï¼š
- è¯¦ç»†çš„APIè¯·æ±‚æ—¥å¿—
- æ¶ˆæ¯æ•°æ®ç»“æ„éªŒè¯æ—¥å¿—
- æ–‡ä»¶ä¸Šä¼ è¿›åº¦å’ŒçŠ¶æ€
- é”™è¯¯åˆ†ç±»å’Œå¤„ç†æ—¥å¿—

### ç¤ºä¾‹æ—¥å¿—è¾“å‡ºï¼š
```
ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶: document.pdf, å¤§å°: 1048576, ç±»å‹: application/pdf
âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: document.pdf
   æ–‡ä»¶URL: /uploads/chat/abc123.pdf
   æ¶ˆæ¯ID: 550e8400-e29b-41d4-a716-446655440000

ğŸ“‹ å¼€å§‹åŠ è½½ 50 æ¡æ¶ˆæ¯ï¼Œå½“å‰ç”¨æˆ·æ ‡è¯†: {'å¼ ä¸‰', 'zhangsan'}
ğŸ“ æ·»åŠ æ¶ˆæ¯: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯...' | ç±»å‹: 'text' | å‘é€è€…: 'å¼ ä¸‰' | è§’è‰²: 'ç³»ç»Ÿæ¶æ„å¸ˆ' | ID: '550e8400...' | æ˜¯å½“å‰ç”¨æˆ·: true
âœ… æ¶ˆæ¯åŠ è½½å®Œæˆï¼Œå…±æ˜¾ç¤º 25 æ¡æ¶ˆæ¯
```

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

ä¿®æ­£åçš„ç¨‹åºå®Œå…¨å…¼å®¹ç°æœ‰çš„ç”¨æˆ·ç•Œé¢ï¼Œæ–°åŠŸèƒ½è‡ªåŠ¨ç”Ÿæ•ˆï¼š

1. **å‘é€æ¶ˆæ¯**ï¼šåŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ï¼Œå¢å¼ºäº†ç¨³å®šæ€§
2. **æ–‡ä»¶ä¸Šä¼ **ï¼šæ”¯æŒæ›´å¤šæ–‡ä»¶ç±»å‹ï¼Œæ›´å®Œå–„çš„é”™è¯¯æç¤º
3. **æ¶ˆæ¯æ˜¾ç¤º**ï¼šè‡ªåŠ¨æ˜¾ç¤ºç”¨æˆ·è§’è‰²ä¿¡æ¯å’ŒèŒä¸šå¤´åƒ
4. **é”™è¯¯å¤„ç†**ï¼šæ›´å‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¿æœºåˆ¶

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

1. **å®æ—¶æ¨é€**ï¼šé›†æˆWebSocketæ”¯æŒ
2. **æ¶ˆæ¯æœç´¢**ï¼šé›†æˆElasticsearchå…¨æ–‡æœç´¢
3. **æ¶ˆæ¯åŠ å¯†**ï¼šç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤
4. **ç¦»çº¿æ¶ˆæ¯**ï¼šç¦»çº¿æ¶ˆæ¯æ¨é€æœºåˆ¶
5. **å¤šåª’ä½“æ”¯æŒ**ï¼šè¯­éŸ³ã€è§†é¢‘æ¶ˆæ¯æ”¯æŒ

---

**ä¿®æ­£å®Œæˆæ—¶é—´**ï¼š2024å¹´6æœˆ17æ—¥  
**ä¿®æ­£ç‰ˆæœ¬**ï¼šv2.0  
**åŸºäºæŠ¥å‘Š**ï¼šã€Šç”¨æˆ·æ¶ˆæ¯å­˜å‚¨å’Œå¤„ç†åˆ†ææŠ¥å‘Š.mdã€‹ 