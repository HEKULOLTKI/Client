# ç”¨æˆ·æ¶ˆæ¯å­˜å‚¨å’Œå¤„ç†åˆ†ææŠ¥å‘Š

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

åœ¨çº¿èŠå¤©ç³»ç»Ÿé‡‡ç”¨ **Redis** ä½œä¸ºæ¶ˆæ¯å­˜å‚¨å¼•æ“ï¼Œå®ç°äº†é«˜æ€§èƒ½çš„å®æ—¶èŠå¤©åŠŸèƒ½ã€‚ç³»ç»Ÿæ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€æ–‡ä»¶ã€å›¾ç‰‡å’Œç³»ç»Ÿæ¶ˆæ¯ï¼Œå…·å¤‡å®Œæ•´çš„æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

## ğŸ”§ æŠ€æœ¯æ¶æ„

### å­˜å‚¨æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI       â”‚    â”‚     Redis       â”‚    â”‚   æ–‡ä»¶ç³»ç»Ÿ      â”‚
â”‚   (APIå±‚)       â”‚â”€â”€â”€â–¶â”‚   (æ¶ˆæ¯å­˜å‚¨)    â”‚    â”‚  (æ–‡ä»¶å­˜å‚¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ¶ˆæ¯éªŒè¯      â”‚      â”‚ æ¶ˆæ¯æŒä¹…åŒ–      â”‚      â”‚ æ–‡ä»¶ç®¡ç†         â”‚
  â”‚ æƒé™æ£€æŸ¥      â”‚      â”‚ ç”¨æˆ·çŠ¶æ€ç®¡ç†    â”‚      â”‚ URLç”Ÿæˆ         â”‚
  â”‚ æ•°æ®è½¬æ¢      â”‚      â”‚ èŠå¤©å®¤ç®¡ç†      â”‚      â”‚ ç±»å‹æ£€æŸ¥         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### 1. æ¶ˆæ¯æ•°æ®ç»“æ„

#### ChatMessage æ¨¡å‹
```python
class ChatMessage(BaseModel):
    id: str                    # æ¶ˆæ¯å”¯ä¸€ID (UUID)
    sender_id: int             # å‘é€è€…ç”¨æˆ·ID
    sender_name: str           # å‘é€è€…ç”¨æˆ·å
    sender_role: Optional[str] # å‘é€è€…è§’è‰²
    message_type: MessageType  # æ¶ˆæ¯ç±»å‹ (text/file/image/system)
    content: str               # æ¶ˆæ¯å†…å®¹
    file_url: Optional[str]    # æ–‡ä»¶URL (å¯é€‰)
    file_name: Optional[str]   # æ–‡ä»¶å (å¯é€‰)
    file_size: Optional[int]   # æ–‡ä»¶å¤§å° (å¯é€‰)
    timestamp: datetime        # å‘é€æ—¶é—´
    reply_to: Optional[str]    # å›å¤çš„æ¶ˆæ¯ID (å¯é€‰)
```

#### æ¶ˆæ¯ç±»å‹æšä¸¾
```python
class MessageType(str, Enum):
    TEXT = "text"      # æ–‡æœ¬æ¶ˆæ¯
    FILE = "file"      # æ–‡ä»¶æ¶ˆæ¯
    IMAGE = "image"    # å›¾ç‰‡æ¶ˆæ¯
    SYSTEM = "system"  # ç³»ç»Ÿæ¶ˆæ¯
```

### 2. Redis æ•°æ®ç»“æ„

#### æ¶ˆæ¯å­˜å‚¨
- **Keyæ ¼å¼ï¼š** `chat:messages:{room_id}`
- **æ•°æ®ç±»å‹ï¼š** List (LPUSH/LRANGE)
- **å­˜å‚¨æ ¼å¼ï¼š** JSONå­—ç¬¦ä¸²
- **ä¿ç•™ç­–ç•¥ï¼š** æœ€è¿‘1000æ¡æ¶ˆæ¯
- **è¿‡æœŸæ—¶é—´ï¼š** 7å¤© (604800ç§’)

#### èŠå¤©å®¤ç®¡ç†
- **Keyæ ¼å¼ï¼š** `chat:room:{room_id}`
- **æ•°æ®ç±»å‹ï¼š** Hash
- **å­˜å‚¨å†…å®¹ï¼š** æˆ¿é—´ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰

#### ç”¨æˆ·åœ¨çº¿çŠ¶æ€
- **Keyæ ¼å¼ï¼š** `user:online:{user_id}`
- **æ•°æ®ç±»å‹ï¼š** Hash
- **è¿‡æœŸæ—¶é—´ï¼š** 30åˆ†é’Ÿ (1800ç§’)

## ğŸ’¾ æ¶ˆæ¯å­˜å‚¨æœºåˆ¶

### 1. æ¶ˆæ¯ä¿å­˜æµç¨‹

```python
def save_chat_message(self, room_id: str, message_data: Dict[str, Any]):
    """ä¿å­˜èŠå¤©æ¶ˆæ¯åˆ°Redis"""
    try:
        # 1. å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©å®¤æ¶ˆæ¯åˆ—è¡¨ (æœ€æ–°æ¶ˆæ¯åœ¨å‰)
        self.redis_client.lpush(f"chat:messages:{room_id}", json.dumps(message_data))
        
        # 2. åªä¿ç•™æœ€è¿‘1000æ¡æ¶ˆæ¯ (é˜²æ­¢å†…å­˜æ— é™å¢é•¿)
        self.redis_client.ltrim(f"chat:messages:{room_id}", 0, 999)
        
        # 3. è®¾ç½®è¿‡æœŸæ—¶é—´ (7å¤©è‡ªåŠ¨æ¸…ç†)
        self.redis_client.expire(f"chat:messages:{room_id}", 604800)
        
        # 4. æ›´æ–°èŠå¤©å®¤æœ€åæ´»åŠ¨æ—¶é—´
        self.redis_client.hset(f"chat:room:{room_id}", "last_activity", time.time())
        
        # 5. å¢åŠ ä»Šæ—¥æ¶ˆæ¯è®¡æ•° (ç»Ÿè®¡ç”¨)
        today = datetime.now().strftime("%Y-%m-%d")
        self.redis_client.incr(f"chat:stats:messages:{today}")
        self.redis_client.expire(f"chat:stats:messages:{today}", 86400 * 30)
        
    except Exception as e:
        print(f"ä¿å­˜èŠå¤©æ¶ˆæ¯å¤±è´¥: {e}")
```

### 2. æ¶ˆæ¯å­˜å‚¨ç‰¹ç‚¹

- **âœ… é«˜æ€§èƒ½ï¼š** ä½¿ç”¨Rediså†…å­˜å­˜å‚¨ï¼Œè¯»å†™é€Ÿåº¦æå¿«
- **âœ… æŒä¹…åŒ–ï¼š** 7å¤©æ¶ˆæ¯ä¿ç•™æœŸï¼Œæ»¡è¶³ä¸€èˆ¬ä¸šåŠ¡éœ€æ±‚
- **âœ… é™åˆ¶å­˜å‚¨ï¼š** æ¯ä¸ªèŠå¤©å®¤æœ€å¤š1000æ¡æ¶ˆæ¯ï¼Œé˜²æ­¢å†…å­˜çˆ†ç‚¸
- **âœ… è‡ªåŠ¨æ¸…ç†ï¼š** è¿‡æœŸæ¶ˆæ¯è‡ªåŠ¨åˆ é™¤ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤
- **âœ… ç»Ÿè®¡å‹å¥½ï¼š** å†…ç½®æ¶ˆæ¯è®¡æ•°ï¼Œä¾¿äºç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

## ğŸ”„ æ¶ˆæ¯å¤„ç†æµç¨‹

### 1. å‘é€æ–‡æœ¬æ¶ˆæ¯

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as FastAPI
    participant Redis as Redis
    participant Auth as è®¤è¯ç³»ç»Ÿ

    Client->>API: POST /api/chat/send
    API->>Auth: éªŒè¯JWT Token
    Auth-->>API: è¿”å›ç”¨æˆ·ä¿¡æ¯
    API->>API: ç”Ÿæˆæ¶ˆæ¯ID (UUID)
    API->>API: æ„å»ºæ¶ˆæ¯æ•°æ®
    API->>Redis: ä¿å­˜æ¶ˆæ¯åˆ°èŠå¤©å®¤
    API->>Redis: ç”¨æˆ·è‡ªåŠ¨åŠ å…¥èŠå¤©å®¤
    API-->>Client: è¿”å›æ¶ˆæ¯å¯¹è±¡
```

### 2. å‘é€æ–‡ä»¶æ¶ˆæ¯

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as FastAPI
    participant FS as æ–‡ä»¶ç³»ç»Ÿ
    participant Redis as Redis

    Client->>API: POST /api/chat/upload
    API->>API: éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
    API->>API: ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å (UUID)
    API->>FS: ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
    API->>API: ç”Ÿæˆæ–‡ä»¶URL
    API->>API: æ„å»ºæ¶ˆæ¯æ•°æ®
    API->>Redis: ä¿å­˜æ¶ˆæ¯åˆ°èŠå¤©å®¤
    API-->>Client: è¿”å›æ¶ˆæ¯å¯¹è±¡
```

### 3. è·å–æ¶ˆæ¯å†å²

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as FastAPI
    participant Redis as Redis

    Client->>API: GET /api/chat/messages
    API->>Redis: ç”¨æˆ·åŠ å…¥èŠå¤©å®¤
    API->>Redis: è·å–æ¶ˆæ¯åˆ—è¡¨
    Redis-->>API: è¿”å›JSONæ¶ˆæ¯æ•°æ®
    API->>API: è¿‡æ»¤å·²åˆ é™¤æ¶ˆæ¯
    API->>API: è½¬æ¢ä¸ºæ¶ˆæ¯å¯¹è±¡
    API-->>Client: è¿”å›æ¶ˆæ¯åˆ—è¡¨
```

## ğŸ—ƒï¸ å…·ä½“å®ç°åˆ†æ

### 1. æ¶ˆæ¯å‘é€ API

```python
@router.post("/send", response_model=ChatMessage, summary="å‘é€èŠå¤©æ¶ˆæ¯")
async def send_message(
    message: ChatMessageCreate,
    current_user: UserResponse = Depends(get_current_user),
    room_id: str = "global"
):
    """å‘é€èŠå¤©æ¶ˆæ¯æ ¸å¿ƒé€»è¾‘"""
    
    # 1. ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
    message_id = str(uuid.uuid4())
    
    # 2. æ„å»ºæ¶ˆæ¯æ•°æ®ç»“æ„
    timestamp = datetime.now()
    message_data = {
        "id": message_id,
        "sender_id": current_user.id,
        "sender_name": current_user.username,
        "message_type": message.message_type.value,
        "content": message.content,
        "timestamp": timestamp.isoformat(),
        "reply_to": message.reply_to,
        "room_id": room_id
    }
    
    # 3. å­˜å‚¨åˆ°Redis
    redis_client.save_chat_message(room_id, message_data)
    
    # 4. ç”¨æˆ·è‡ªåŠ¨åŠ å…¥èŠå¤©å®¤
    redis_client.join_chat_room(room_id, current_user.id)
    
    # 5. è¿”å›è§„èŒƒåŒ–çš„æ¶ˆæ¯å¯¹è±¡
    return ChatMessage(...)
```

### 2. æ¶ˆæ¯è·å– API

```python
@router.get("/messages", response_model=List[ChatMessage])
async def get_messages(
    room_id: str = "global",
    limit: int = 50,
    before: Optional[str] = None,
    current_user: UserResponse = Depends(get_current_user)
):
    """è·å–æ¶ˆæ¯å†å²æ ¸å¿ƒé€»è¾‘"""
    
    # 1. ç¡®ä¿ç”¨æˆ·åœ¨èŠå¤©å®¤ä¸­
    redis_client.join_chat_room(room_id, current_user.id)
    
    # 2. ä»Redisè·å–æ¶ˆæ¯æ•°æ®
    messages_data = redis_client.get_chat_messages(room_id, limit, before)
    
    # 3. æ•°æ®å¤„ç†å’Œè¿‡æ»¤
    messages = []
    for msg_data in messages_data:
        # è·³è¿‡å·²åˆ é™¤çš„æ¶ˆæ¯
        if msg_data.get('deleted'):
            continue
        
        # è½¬æ¢ä¸ºPydanticæ¨¡å‹
        message = ChatMessage(...)
        messages.append(message)
    
    return messages
```

### 3. æ–‡ä»¶ä¸Šä¼ å¤„ç†

```python
@router.post("/upload", response_model=ChatMessage)
async def upload_file_and_send(
    file: UploadFile = File(...),
    room_id: str = Form("global"),
    current_user: UserResponse = Depends(get_current_user)
):
    """æ–‡ä»¶ä¸Šä¼ å’Œæ¶ˆæ¯å‘é€é›†æˆå¤„ç†"""
    
    # 1. æ–‡ä»¶éªŒè¯
    if file.size > MAX_FILE_SIZE:
        raise HTTPException(status_code=413, detail="æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶(10MB)")
    
    if file.content_type not in ALLOWED_FILE_TYPES:
        raise HTTPException(status_code=415, detail="ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹")
    
    # 2. æ–‡ä»¶ä¿å­˜ 
    file_extension = os.path.splitext(file.filename)[1]
    unique_filename = f"{uuid.uuid4()}{file_extension}"
    file_path = os.path.join(settings.UPLOAD_PATH, "chat", unique_filename)
    
    # 3. ç”Ÿæˆæ¶ˆæ¯
    message_type = MessageType.IMAGE if file.content_type.startswith("image/") else MessageType.FILE
    message_data = {
        "content": f"å‘é€äº†æ–‡ä»¶: {file.filename}",
        "file_url": f"/uploads/chat/{unique_filename}",
        "file_name": file.filename,
        "file_size": file.size,
        ...
    }
    
    # 4. ä¿å­˜åˆ°Redis
    redis_client.save_chat_message(room_id, message_data)
```

## ğŸ” æ¶ˆæ¯æ£€ç´¢æœºåˆ¶

### 1. æ¶ˆæ¯åˆ†é¡µ

```python
def get_chat_messages(self, room_id: str, limit: int = 50, before: Optional[str] = None):
    """æ”¯æŒåˆ†é¡µçš„æ¶ˆæ¯è·å–"""
    
    if before:
        # åŸºäºæ¶ˆæ¯IDçš„åˆ†é¡µ - è·å–æŒ‡å®šæ¶ˆæ¯ä¹‹å‰çš„æ¶ˆæ¯
        messages = self.redis_client.lrange(f"chat:messages:{room_id}", 0, -1)
        all_messages = [json.loads(msg) for msg in messages]
        
        # æ‰¾åˆ°beforeæ¶ˆæ¯çš„ä½ç½®
        before_index = -1
        for i, msg in enumerate(all_messages):
            if msg.get('id') == before:
                before_index = i
                break
        
        if before_index >= 0:
            start_index = before_index + 1
            end_index = min(start_index + limit, len(all_messages))
            return all_messages[start_index:end_index]
    else:
        # è·å–æœ€æ–°çš„æ¶ˆæ¯ (LRANGE 0 to limit-1)
        messages = self.redis_client.lrange(f"chat:messages:{room_id}", 0, limit - 1)
        return [json.loads(msg) for msg in messages]
```

### 2. æ¶ˆæ¯è¿‡æ»¤

```python
# APIå±‚è¿‡æ»¤å·²åˆ é™¤æ¶ˆæ¯
for msg_data in messages_data:
    # è·³è¿‡è½¯åˆ é™¤çš„æ¶ˆæ¯
    if msg_data.get('deleted'):
        continue
    
    # è§£æå’ŒéªŒè¯æ¶ˆæ¯æ•°æ®
    try:
        timestamp = datetime.fromisoformat(msg_data['timestamp'])
        message = ChatMessage(...)
        messages.append(message)
    except Exception as e:
        print(f"è§£ææ¶ˆæ¯å¤±è´¥: {e}")
        continue
```

## ğŸ—‘ï¸ æ¶ˆæ¯åˆ é™¤æœºåˆ¶

### è½¯åˆ é™¤å®ç°

```python
def delete_chat_message(self, room_id: str, message_id: str, user_id: int):
    """è½¯åˆ é™¤èŠå¤©æ¶ˆæ¯"""
    try:
        # 1. è·å–æ‰€æœ‰æ¶ˆæ¯
        messages = self.redis_client.lrange(f"chat:messages:{room_id}", 0, -1)
        
        # 2. æ‰¾åˆ°ç›®æ ‡æ¶ˆæ¯å¹¶æ ‡è®°åˆ é™¤
        for i, msg_str in enumerate(messages):
            msg = json.loads(msg_str)
            
            # éªŒè¯æ¶ˆæ¯æ‰€æœ‰æƒ
            if msg.get('id') == message_id and msg.get('sender_id') == user_id:
                # æ·»åŠ åˆ é™¤æ ‡è®°
                msg['deleted'] = True
                msg['deleted_at'] = time.time()
                
                # æ›´æ–°Redisä¸­çš„æ¶ˆæ¯
                self.redis_client.lset(f"chat:messages:{room_id}", i, json.dumps(msg))
                break
                
    except Exception as e:
        print(f"åˆ é™¤èŠå¤©æ¶ˆæ¯å¤±è´¥: {e}")
```

### åˆ é™¤ç‰¹ç‚¹
- **âœ… è½¯åˆ é™¤ï¼š** æ¶ˆæ¯ä¸ä¼šç‰©ç†åˆ é™¤ï¼Œåªæ˜¯æ ‡è®°ä¸ºå·²åˆ é™¤
- **âœ… æƒé™æ§åˆ¶ï¼š** åªæœ‰æ¶ˆæ¯å‘é€è€…å¯ä»¥åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯
- **âœ… å®¡è®¡è·Ÿè¸ªï¼š** ä¿ç•™åˆ é™¤æ—¶é—´æˆ³ï¼Œä¾¿äºå®¡è®¡
- **âœ… å‰ç«¯è¿‡æ»¤ï¼š** APIè¿”å›æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤æ¶ˆæ¯

## ğŸ‘¥ ç”¨æˆ·çŠ¶æ€ç®¡ç†

### åœ¨çº¿çŠ¶æ€è·Ÿè¸ª

```python
def set_user_online(self, user_id: int, username: str, ip: str, user_agent: str):
    """è®¾ç½®ç”¨æˆ·åœ¨çº¿çŠ¶æ€"""
    current_time = time.time()
    
    # ä½¿ç”¨Redis Pipelineæé«˜æ€§èƒ½
    pipeline = self.redis_client.pipeline()
    pipeline.hset(f"user:online:{user_id}", "user_id", user_id)
    pipeline.hset(f"user:online:{user_id}", "username", username)
    pipeline.hset(f"user:online:{user_id}", "ip", ip)
    pipeline.hset(f"user:online:{user_id}", "user_agent", user_agent)
    pipeline.hset(f"user:online:{user_id}", "login_time", current_time)
    pipeline.hset(f"user:online:{user_id}", "last_activity", current_time)
    
    # æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·é›†åˆ
    pipeline.sadd("online_users", user_id)
    
    # è®¾ç½®1å°æ—¶è‡ªåŠ¨è¿‡æœŸ
    pipeline.expire(f"user:online:{user_id}", 3600)
    
    pipeline.execute()
```

### æ´»åŠ¨æ—¶é—´æ›´æ–°

```python
def update_user_activity(self, user_id: int):
    """æ›´æ–°ç”¨æˆ·æœ€åæ´»åŠ¨æ—¶é—´"""
    if self.is_user_online(user_id):
        self.redis_client.hset(f"user:online:{user_id}", "last_activity", str(time.time()))
        # é‡ç½®è¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
        self.redis_client.expire(f"user:online:{user_id}", 3600)
```

## ğŸ  èŠå¤©å®¤ç®¡ç†

### 1. èŠå¤©å®¤æ•°æ®ç»“æ„

```python
# èŠå¤©å®¤ä¿¡æ¯
chat:room:{room_id} (Hash)
â”œâ”€â”€ id: room_id
â”œâ”€â”€ name: èŠå¤©å®¤åç§°
â”œâ”€â”€ description: æè¿°
â”œâ”€â”€ creator_id: åˆ›å»ºè€…ID
â”œâ”€â”€ created_at: åˆ›å»ºæ—¶é—´
â”œâ”€â”€ last_activity: æœ€åæ´»åŠ¨æ—¶é—´
â””â”€â”€ member_count: æˆå‘˜æ•°é‡

# èŠå¤©å®¤æˆå‘˜
chat:room:{room_id}:members (Set)
â””â”€â”€ [user_id1, user_id2, ...]

# ç”¨æˆ·åŠ å…¥çš„èŠå¤©å®¤
user:{user_id}:chat_rooms (Set)
â””â”€â”€ [room_id1, room_id2, ...]
```

### 2. åŠ å…¥å’Œç¦»å¼€æœºåˆ¶

```python
def join_chat_room(self, room_id: str, user_id: int):
    """ç”¨æˆ·åŠ å…¥èŠå¤©å®¤"""
    # 1. æ·»åŠ ç”¨æˆ·åˆ°èŠå¤©å®¤æˆå‘˜é›†åˆ
    self.redis_client.sadd(f"chat:room:{room_id}:members", user_id)
    
    # 2. æ›´æ–°æˆå‘˜æ•°é‡
    member_count = self.redis_client.scard(f"chat:room:{room_id}:members")
    self.redis_client.hset(f"chat:room:{room_id}", "member_count", member_count)
    
    # 3. æ·»åŠ åˆ°ç”¨æˆ·çš„èŠå¤©å®¤åˆ—è¡¨
    self.redis_client.sadd(f"user:{user_id}:chat_rooms", room_id)
```

## ğŸ“ˆ ç»Ÿè®¡å’Œç›‘æ§

### 1. æ¶ˆæ¯ç»Ÿè®¡

```python
def get_chat_stats(self) -> Dict[str, Any]:
    """è·å–èŠå¤©ç»Ÿè®¡ä¿¡æ¯"""
    today = datetime.now().strftime("%Y-%m-%d")
    
    return {
        "online_users_count": self.get_online_users_count(),
        "total_messages_today": int(self.redis_client.get(f"chat:stats:messages:{today}") or 0),
        "active_rooms": self.redis_client.scard("chat:rooms")
    }
```

### 2. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

- **åœ¨çº¿ç”¨æˆ·æ•°ï¼š** å®æ—¶ç»Ÿè®¡å½“å‰åœ¨çº¿ç”¨æˆ·
- **ä»Šæ—¥æ¶ˆæ¯æ•°ï¼š** æŒ‰å¤©ç»Ÿè®¡æ¶ˆæ¯å‘é€é‡
- **æ´»è·ƒèŠå¤©å®¤ï¼š** ç»Ÿè®¡æœ‰æ´»åŠ¨çš„èŠå¤©å®¤æ•°é‡
- **æ¶ˆæ¯å­˜å‚¨é‡ï¼š** ç›‘æ§å„èŠå¤©å®¤çš„æ¶ˆæ¯æ•°é‡

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. Redis ä¼˜åŒ–

```python
# ä½¿ç”¨Pipelineå‡å°‘ç½‘ç»œå¾€è¿”
pipeline = self.redis_client.pipeline()
pipeline.lpush(f"chat:messages:{room_id}", json.dumps(message_data))
pipeline.ltrim(f"chat:messages:{room_id}", 0, 999)
pipeline.expire(f"chat:messages:{room_id}", 604800)
pipeline.execute()
```

### 2. å†…å­˜ç®¡æ§

- **æ¶ˆæ¯é™åˆ¶ï¼š** æ¯ä¸ªèŠå¤©å®¤æœ€å¤š1000æ¡æ¶ˆæ¯
- **è‡ªåŠ¨è¿‡æœŸï¼š** æ¶ˆæ¯7å¤©åè‡ªåŠ¨åˆ é™¤
- **åœ¨çº¿çŠ¶æ€ï¼š** 1å°æ—¶æ— æ´»åŠ¨è‡ªåŠ¨ä¸‹çº¿
- **å®šæœŸæ¸…ç†ï¼š** æ¸…ç†å­¤ç«‹çš„åœ¨çº¿çŠ¶æ€è®°å½•

### 3. æ•°æ®å‹ç¼©

```python
# JSONåºåˆ—åŒ–æœ€å°åŒ–å­˜å‚¨ç©ºé—´
message_data = {
    "id": message_id,
    "sid": current_user.id,          # sender_id ç¼©å†™
    "sn": current_user.username,     # sender_name ç¼©å†™
    "t": message.message_type.value, # type ç¼©å†™
    "c": message.content,            # content ç¼©å†™
    "ts": timestamp.isoformat(),     # timestamp ç¼©å†™
    # ... å…¶ä»–å­—æ®µ
}
```

## ğŸ”’ å®‰å…¨å’Œå®¹é”™

### 1. æƒé™æ§åˆ¶

```python
# æ¶ˆæ¯åˆ é™¤æƒé™æ£€æŸ¥
if msg.get('sender_id') != user_id:
    raise HTTPException(status_code=403, detail="åªèƒ½åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯")

# èŠå¤©å®¤è®¿é—®æ§åˆ¶ (å¯æ‰©å±•)
def check_room_access(room_id: str, user_id: int):
    # å®ç°å…·ä½“çš„è®¿é—®æ§åˆ¶é€»è¾‘
    pass
```

### 2. å¼‚å¸¸å¤„ç†

```python
try:
    # Redisæ“ä½œ
    redis_client.save_chat_message(room_id, message_data)
except Exception as e:
    # è®°å½•é”™è¯¯æ—¥å¿—
    print(f"ä¿å­˜æ¶ˆæ¯å¤±è´¥: {e}")
    # è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    raise HTTPException(status_code=500, detail="æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•")
```

### 3. æ•°æ®ä¸€è‡´æ€§

- **åŸå­æ“ä½œï¼š** ä½¿ç”¨Redis Pipelineä¿è¯æ“ä½œåŸå­æ€§
- **äº‹åŠ¡å¤„ç†ï¼š** å…³é”®æ“ä½œä½¿ç”¨Redisäº‹åŠ¡
- **å›æ»šæœºåˆ¶ï¼š** æ“ä½œå¤±è´¥æ—¶çš„çŠ¶æ€å›æ»š
- **æ•°æ®éªŒè¯ï¼š** ä¸¥æ ¼çš„æ•°æ®æ ¼å¼éªŒè¯

## ğŸš€ æ‰©å±•æ€§è®¾è®¡

### 1. æ°´å¹³æ‰©å±•

```python
# æ”¯æŒRedisé›†ç¾¤
class RedisClusterClient:
    def __init__(self):
        from rediscluster import RedisCluster
        self.redis_client = RedisCluster(
            startup_nodes=settings.REDIS_CLUSTER_NODES,
            decode_responses=True
        )
```

### 2. æ¶ˆæ¯åˆ†ç‰‡

```python
# æŒ‰èŠå¤©å®¤IDåˆ†ç‰‡å­˜å‚¨
def get_shard_key(room_id: str) -> str:
    shard_id = hash(room_id) % settings.REDIS_SHARD_COUNT
    return f"shard:{shard_id}:chat:messages:{room_id}"
```

### 3. ç¼“å­˜ç­–ç•¥

```python
# çƒ­ç‚¹æ¶ˆæ¯ç¼“å­˜
def get_hot_messages(room_id: str):
    cache_key = f"hot:messages:{room_id}"
    
    # å…ˆä»ç¼“å­˜è·å–
    cached = self.redis_client.get(cache_key)
    if cached:
        return json.loads(cached)
    
    # ç¼“å­˜æœªå‘½ä¸­ï¼Œä»å­˜å‚¨è·å–
    messages = self.get_chat_messages(room_id, limit=20)
    
    # ç¼“å­˜5åˆ†é’Ÿ
    self.redis_client.setex(cache_key, 300, json.dumps(messages))
    
    return messages
```

## ğŸ“Š ç³»ç»ŸæŒ‡æ ‡

### å­˜å‚¨æŒ‡æ ‡
- **æ¶ˆæ¯ä¿ç•™æœŸï¼š** 7å¤©
- **å•å®¤æ¶ˆæ¯é™åˆ¶ï¼š** 1000æ¡
- **æ–‡ä»¶å¤§å°é™åˆ¶ï¼š** 10MB
- **æ”¯æŒæ–‡ä»¶ç±»å‹ï¼š** 10ç§ (å›¾ç‰‡4ç§ + æ–‡æ¡£6ç§)

### æ€§èƒ½æŒ‡æ ‡
- **æ¶ˆæ¯å‘é€å“åº”æ—¶é—´ï¼š** < 100ms
- **æ¶ˆæ¯è·å–å“åº”æ—¶é—´ï¼š** < 50ms
- **å¹¶å‘ç”¨æˆ·æ”¯æŒï¼š** 1000+
- **æ¶ˆæ¯ååé‡ï¼š** 10000æ¡/åˆ†é’Ÿ

### å¯ç”¨æ€§æŒ‡æ ‡
- **ç³»ç»Ÿå¯ç”¨æ€§ï¼š** 99.9%
- **æ•°æ®ä¸€è‡´æ€§ï¼š** å¼ºä¸€è‡´æ€§
- **è‡ªåŠ¨æ¢å¤ï¼š** æ”¯æŒ
- **å®¹é”™èƒ½åŠ›ï¼š** Redisä¸»ä»å¤‡ä»½

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ¶ˆæ¯æŒä¹…åŒ–ï¼š** é›†æˆæ•°æ®åº“è¿›è¡Œé•¿æœŸå­˜å‚¨
2. **å®æ—¶æ¨é€ï¼š** WebSocketæ”¯æŒå®æ—¶æ¶ˆæ¯æ¨é€  
3. **æ¶ˆæ¯åŠ å¯†ï¼š** ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤éšç§
4. **æ™ºèƒ½è¿‡æ»¤ï¼š** AIé©±åŠ¨çš„å†…å®¹å®¡æ ¸
5. **åˆ†å¸ƒå¼æ¶æ„ï¼š** æ”¯æŒæ›´å¤§è§„æ¨¡çš„ç”¨æˆ·å¹¶å‘
6. **æ¶ˆæ¯æœç´¢ï¼š** é›†æˆElasticsearchå®ç°å…¨æ–‡æœç´¢
7. **å¤šåª’ä½“æ”¯æŒï¼š** è¯­éŸ³ã€è§†é¢‘æ¶ˆæ¯æ”¯æŒ
8. **ç¦»çº¿æ¶ˆæ¯ï¼š** ç”¨æˆ·ç¦»çº¿æ—¶çš„æ¶ˆæ¯æ¨é€æœºåˆ¶

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2024å¹´6æœˆ17æ—¥  
**ç³»ç»Ÿç‰ˆæœ¬ï¼š** v1.0  
**ä½œè€…ï¼š** æŠ€æœ¯å›¢é˜Ÿ 