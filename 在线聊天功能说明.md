# 在线聊天功能说明

## 概述

新的在线聊天功能已成功集成到Desktop Manager中，采用AI Desktop Pet聊天框的设计风格，但专门用于在线多人聊天。

## 功能特性

### 🎨 界面设计
- **现代化UI**: 采用与AI Desktop Pet相同的圆角设计和渐变效果
- **响应式布局**: 支持拖拽移动，窗口阴影效果
- **双栏布局**: 左侧聊天区域，右侧在线用户列表
- **绿色主题**: 采用#2ecc71绿色作为主色调，区别于AI宠物的蓝色主题

### 💬 聊天功能
- **实时消息**: 支持发送和接收文本消息
- **消息气泡**: 用户消息显示在右侧（绿色），其他用户消息显示在左侧（灰色）
- **时间戳**: 显示消息发送时间
- **发送者信息**: 显示发送者用户名
- **消息历史**: 自动滚动到最新消息

### 👥 用户管理
- **在线用户列表**: 右侧显示当前在线用户
- **用户头像**: 每个用户显示头像和在线状态
- **用户统计**: 顶部显示在线用户数量

### 🔧 工具功能
- **文件上传**: 支持图片和文档文件上传（开发中）
- **刷新功能**: 手动刷新聊天内容和用户列表
- **心跳检测**: 自动维持在线状态（每30秒）

## 使用方法

### 启动聊天
1. 运行 `python desktop_manager.py`
2. 点击顶部栏的"💬 聊天"按钮
3. 或使用快捷键 `F2`

### 发送消息
1. 在底部输入框中输入消息
2. 点击"发送"按钮或按回车键
3. 消息将显示在聊天区域的右侧

### 查看在线用户
- 右侧用户列表显示所有在线用户
- 顶部显示在线用户总数
- 每个用户显示头像和在线状态

## API接口集成

聊天功能已与后端API完全集成，支持：

- **发送消息**: `POST /api/chat/send`
- **获取消息历史**: `GET /api/chat/messages`
- **获取在线用户**: `GET /api/chat/online-users`
- **文件上传**: `POST /api/chat/upload`
- **心跳检测**: `POST /api/chat/heartbeat`

详细API说明请参考 `API接口说明文档.md`

## 技术实现

### 核心组件
- `OnlineChatWidget`: 主聊天窗口组件
- `OnlineChatBubble`: 消息气泡组件
- `OnlineChatAPI`: API通信线程
- `OnlineLoadingIndicator`: 加载指示器

### 主要文件
- `online_chat_widget.py`: 在线聊天窗口实现
- `desktop_manager.py`: 主程序集成
- `test_online_chat.py`: 功能测试脚本

### 样式特色
```css
/* 主要颜色 */
主色调: #2ecc71 (绿色)
悬停色: #27ae60 (深绿色)
背景色: #f8f9fa (浅灰色)
边框色: #E8E8E8 (灰色)

/* 圆角设计 */
窗口圆角: 20px
按钮圆角: 22px
消息气泡圆角: 18px
```

## 配置选项

### 用户信息设置
```python
# 在desktop_manager.py中自动从角色数据获取
username = self.current_role_data.get('username', '当前用户')
chat_widget.set_user_info(username)
```

### API配置
```python
# 在online_chat_widget.py中
base_url = "http://localhost:8000"  # API服务器地址
room_id = "global"  # 默认聊天室
```

## 测试方法

### 单独测试
```bash
python test_online_chat.py
```

### 集成测试
```bash
python desktop_manager.py
# 点击聊天按钮或按F2键
```

## 注意事项

1. **网络连接**: 需要后端API服务器运行在localhost:8000
2. **认证**: 需要有效的JWT Token进行API认证
3. **实时性**: 目前通过手动刷新获取新消息，未来可考虑WebSocket
4. **文件上传**: 当前为功能预留，完整实现需要与后端API对接

## 与AI Desktop Pet的区别

| 功能 | AI Desktop Pet聊天 | 在线聊天 |
|------|-------------------|----------|
| 主色调 | 蓝色 (#0066FF) | 绿色 (#2ecc71) |
| 聊天对象 | AI宠物 | 在线用户 |
| 消息存储 | 本地会话 | 服务器数据库 |
| 用户列表 | 无 | 右侧用户列表 |
| 文件支持 | 无 | 支持文件上传 |
| 网络依赖 | OpenAI API | 后端聊天API |

## 后续优化

1. **WebSocket集成**: 实现真正的实时聊天
2. **表情符号**: 添加表情符号支持
3. **消息类型**: 支持图片、文件等多媒体消息
4. **私聊功能**: 支持用户间私人对话
5. **消息通知**: 新消息桌面通知功能 